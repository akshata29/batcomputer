resources:
- repo: self
queue:
  name: Hosted Ubuntu 1604
variables:
  storage.account: 'bcmisc'
  storage.container: 'titanic-ml'

steps:
- script: |
   export AZURE_STORAGE_ACCOUNT="$(storage.account)"
   export AZURE_STORAGE_KEY="$(storage.key)"
   export BLOB_CONTAINER="$(storage.container)"
   export VERSION="$(version)"
   
   source ./scripts/get-pickles.sh
   
  displayName: 'Get versioned model and pickle files'

- task: Docker@1
  displayName: 'Build API server image'
  inputs:
    azureSubscriptionEndpoint: 'Microsoft (AIRS) (52512f28-c6ed-403e-9569-82a9fb9fec91)'

    azureContainerRegistry: bcdemo.azurecr.io

    arguments: '--build-arg VERSION=$(version)'

    imageName: '$(image.name):$(version)'


- task: Docker@1
  displayName: 'Push API server image'
  inputs:
    azureSubscriptionEndpoint: 'Microsoft (AIRS) (52512f28-c6ed-403e-9569-82a9fb9fec91)'

    azureContainerRegistry: bcdemo.azurecr.io

    command: 'Push an image'

    imageName: '$(image.name):$(version)'
